   1               		.file	"i2c.c"
   2               	__SREG__ = 0x3f
   3               	__SP_H__ = 0x3e
   4               	__SP_L__ = 0x3d
   5               	__CCP__  = 0x34
   6               	__tmp_reg__ = 0
   7               	__zero_reg__ = 1
   8               		.global __do_copy_data
   9               		.global __do_clear_bss
  11               		.text
  12               	.Ltext0:
 102               		.section	.text.i2c_init,"ax",@progbits
 104               	.global	i2c_init
 106               	i2c_init:
   1:i2c.c         **** /************************************************************************/
   2:i2c.c         **** /* XBoot Extensible AVR Bootloader                                      */
   3:i2c.c         **** /*                                                                      */
   4:i2c.c         **** /* I2C/TWI Module                                                       */
   5:i2c.c         **** /*                                                                      */
   6:i2c.c         **** /* i2c.c                                                                */
   7:i2c.c         **** /*                                                                      */
   8:i2c.c         **** /* Alex Forencich <alex@alexforencich.com>                              */
   9:i2c.c         **** /*                                                                      */
  10:i2c.c         **** /* Copyright (c) 2010 Alex Forencich                                    */
  11:i2c.c         **** /*                                                                      */
  12:i2c.c         **** /* Permission is hereby granted, free of charge, to any person          */
  13:i2c.c         **** /* obtaining a copy of this software and associated documentation       */
  14:i2c.c         **** /* files(the "Software"), to deal in the Software without restriction,  */
  15:i2c.c         **** /* including without limitation the rights to use, copy, modify, merge, */
  16:i2c.c         **** /* publish, distribute, sublicense, and/or sell copies of the Software, */
  17:i2c.c         **** /* and to permit persons to whom the Software is furnished to do so,    */
  18:i2c.c         **** /* subject to the following conditions:                                 */
  19:i2c.c         **** /*                                                                      */
  20:i2c.c         **** /* The above copyright notice and this permission notice shall be       */
  21:i2c.c         **** /* included in all copies or substantial portions of the Software.      */
  22:i2c.c         **** /*                                                                      */
  23:i2c.c         **** /* THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,      */
  24:i2c.c         **** /* EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF   */
  25:i2c.c         **** /* MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND                */
  26:i2c.c         **** /* NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS  */
  27:i2c.c         **** /* BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN   */
  28:i2c.c         **** /* ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN    */
  29:i2c.c         **** /* CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE     */
  30:i2c.c         **** /* SOFTWARE.                                                            */
  31:i2c.c         **** /*                                                                      */
  32:i2c.c         **** /************************************************************************/
  33:i2c.c         **** 
  34:i2c.c         **** #include "i2c.h"
  35:i2c.c         **** 
  36:i2c.c         **** // Globals
  37:i2c.c         **** #ifdef USE_I2C
  38:i2c.c         **** unsigned char first_byte;
  39:i2c.c         **** #endif
  40:i2c.c         **** 
  41:i2c.c         **** // Interrupts
  42:i2c.c         **** #ifdef USE_INTERRUPTS
  43:i2c.c         **** #ifdef USE_I2C
  44:i2c.c         **** ISR(I2C_DEVICE_ISR)
  45:i2c.c         **** {
  46:i2c.c         ****         if ((I2C_DEVICE.SLAVE.STATUS & TWI_SLAVE_APIF_bm) && 
  47:i2c.c         ****                 (I2C_DEVICE.SLAVE.STATUS & TWI_SLAVE_AP_bm))
  48:i2c.c         ****         {
  49:i2c.c         ****                 // Address match, send ACK
  50:i2c.c         ****                 I2C_DEVICE.SLAVE.CTRLB = 0b00000011;
  51:i2c.c         ****                 comm_mode = MODE_I2C;
  52:i2c.c         ****                 #ifdef USE_UART
  53:i2c.c         ****                 #ifdef __AVR_XMEGA__
  54:i2c.c         ****                 // disable I2C interrupt
  55:i2c.c         ****                 UART_DEVICE.CTRLA = 0;
  56:i2c.c         ****                 #endif // __AVR_XMEGA__
  57:i2c.c         ****                 #endif // USE_UART
  58:i2c.c         ****                 first_byte = 1;
  59:i2c.c         ****         }
  60:i2c.c         ****         if ((I2C_DEVICE.SLAVE.STATUS & TWI_SLAVE_DIF_bm) &&
  61:i2c.c         ****                 !(I2C_DEVICE.SLAVE.STATUS & TWI_SLAVE_DIR_bm))
  62:i2c.c         ****         {
  63:i2c.c         ****                 // Data has arrived
  64:i2c.c         ****                 if (rx_char_cnt == 0)
  65:i2c.c         ****                 {
  66:i2c.c         ****                         rx_buff0 = I2C_DEVICE.SLAVE.DATA;
  67:i2c.c         ****                         rx_char_cnt = 1;
  68:i2c.c         ****                 }
  69:i2c.c         ****                 else
  70:i2c.c         ****                 {
  71:i2c.c         ****                         rx_buff1 = I2C_DEVICE.SLAVE.DATA;
  72:i2c.c         ****                         rx_char_cnt = 2;
  73:i2c.c         ****                 }
  74:i2c.c         ****                 I2C_DEVICE.SLAVE.CTRLB = 0b00000011;
  75:i2c.c         ****         }
  76:i2c.c         ****         if ((I2C_DEVICE.SLAVE.STATUS & TWI_SLAVE_DIF_bm) &&
  77:i2c.c         ****                 (I2C_DEVICE.SLAVE.STATUS & TWI_SLAVE_DIR_bm))
  78:i2c.c         ****         {
  79:i2c.c         ****                 if (!first_byte && I2C_DEVICE.SLAVE.STATUS & TWI_SLAVE_RXACK_bm)
  80:i2c.c         ****                 {
  81:i2c.c         ****                         I2C_DEVICE.SLAVE.CTRLB = 0b00000010; // end transaction
  82:i2c.c         ****                 }
  83:i2c.c         ****                 else
  84:i2c.c         ****                 {
  85:i2c.c         ****                         first_byte = 0;
  86:i2c.c         ****                         if (tx_char_cnt == 0)
  87:i2c.c         ****                         {
  88:i2c.c         ****                                 // Wants data, but there is no data to send...
  89:i2c.c         ****                                 // also include NAK
  90:i2c.c         ****                                 I2C_DEVICE.SLAVE.DATA = '?';
  91:i2c.c         ****                         }
  92:i2c.c         ****                         else
  93:i2c.c         ****                         {
  94:i2c.c         ****                                 I2C_DEVICE.SLAVE.DATA = tx_buff0;
  95:i2c.c         ****                                 tx_char_cnt = 0;
  96:i2c.c         ****                         }
  97:i2c.c         ****                         I2C_DEVICE.SLAVE.CTRLB = 0b00000110;
  98:i2c.c         ****                 }
  99:i2c.c         ****         }
 100:i2c.c         **** }
 101:i2c.c         **** #endif // USE_I2C
 102:i2c.c         **** #endif // USE_INTERRUPTS
 103:i2c.c         **** 
 104:i2c.c         **** void __attribute__ ((always_inline)) i2c_init(void)
 105:i2c.c         **** {
 107               	i2c_init, @function
 108               	i2c_init:
 110               	.LM0:
 111               	.LFBB1:
 112               	/* prologue: function */
 106:i2c.c         ****  ((always_inline)) i2c_init(void)
 107:i2c.c         **** {
 108:i2c.c         **** #ifdef __AVR_XMEGA__
 109:i2c.c         ****         I2C_DEVICE.CTRL = 0;
 110:i2c.c         ****         #if I2C_MATCH_ANY
 111:i2c.c         ****         #ifdef USE_INTERRUPTS
 112:i2c.c         ****         I2C_DEVICE.SLAVE.CTRLA = TWI_SLAVE_ENABLE_bm | TWI_SLAVE_PMEN_bm | TWI_SLAVE_INTLVL0_bm;
 113:i2c.c         ****         #else
 114:i2c.c         ****         I2C_DEVICE.SLAVE.CTRLA = TWI_SLAVE_ENABLE_bm | TWI_SLAVE_PMEN_bm;
 115:i2c.c         ****         #endif // USE_INTERRUPTS
 116:i2c.c         ****         #else
 117:i2c.c         ****         #ifdef USE_INTERRUPTS
 118:i2c.c         ****         I2C_DEVICE.SLAVE.CTRLA = TWI_SLAVE_ENABLE_bm | TWI_SLAVE_INTLVL0_bm;
 119:i2c.c         ****         #else
 120:i2c.c         ****         I2C_DEVICE.SLAVE.CTRLA = TWI_SLAVE_ENABLE_bm;
 121:i2c.c         ****         #endif // USE_INTERRUPTS
 122:i2c.c         ****         #endif
 123:i2c.c         ****         #if I2C_GC_ENABLE
 124:i2c.c         ****         I2C_DEVICE.SLAVE.ADDR = I2C_ADDRESS | 1;
 125:i2c.c         ****         #else
 126:i2c.c         ****         I2C_DEVICE.SLAVE.ADDR = I2C_ADDRESS;
 127:i2c.c         ****         #endif
 128:i2c.c         ****         I2C_DEVICE.SLAVE.ADDRMASK = 0;
 113               	
 114               	/* prologue: function */
 115 0000 0895      	/* frame size = 0 */
 116               	/* epilogue start */
 118               	.LM1:
 119               		ret
 121               	.Lscope1:
 122               		.section	.text.i2c_deinit,"ax",@progbits
 129:i2c.c         **** .ADDRMASK = 0;
 130:i2c.c         **** #endif // __AVR_XMEGA__
 131:i2c.c         **** }
 123               	it,"ax",@progbits
 125               	.global	i2c_deinit
 127               	i2c_deinit:
 132:i2c.c         **** VR_XMEGA__
 133:i2c.c         **** }
 134:i2c.c         **** 
 135:i2c.c         **** void __attribute__ ((always_inline)) i2c_deinit(void)
 136:i2c.c         **** {
 137:i2c.c         ****         // Shut down I2C module and turn off interrupt
 138:i2c.c         **** #ifdef __AVR_XMEGA__
 129               	,.LM2-.LFBB2
 130               	.LM2:
 131 0000 0895      	.LFBB2:
 132               	/* prologue: function */
 133               	/* frame size = 0 */
 134               	/* epilogue start */
 136               	.LM3:
DEFINED SYMBOLS
                            *ABS*:00000000 i2c.c
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:2      *ABS*:0000003f __SREG__
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:3      *ABS*:0000003e __SP_H__
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:4      *ABS*:0000003d __SP_L__
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:5      *ABS*:00000034 __CCP__
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:6      *ABS*:00000000 __tmp_reg__
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:7      *ABS*:00000001 __zero_reg__
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:106    .text.i2c_init:00000000 i2c_init
C:\DOCUME~1\Edwin\LOCALS~1\Temp/ccfEZfxW.s:122    .text.i2c_deinit:00000000 i2c_deinit

UNDEFINED SYMBOLS
__do_copy_data
__do_clear_bss
